#!/sbin/sh
#

OUTFD=$2
ZIP=$3

SYSTEMLIB=/system/lib

ui_print() {
  echo -n -e "ui_print $1\n" > /proc/self/fd/$OUTFD
  echo -n -e "ui_print\n" > /proc/self/fd/$OUTFD
}

cp_perm() {
  rm $5
  if [ -f "$4" ]; then
    cat $4 > $5
    set_perm $1 $2 $3 $5 $6
  fi
}

ui_print "*****************"
ui_print "OSS installer"
ui_print "*****************"

ui_print "- Mounting /system, /data and rootfs"
mount /system
mount /data
mount -o rw,remount /system
mount -o rw,remount /system /system
mount -o rw,remount /
mount -o rw,remount / /


APKNAME=/system/app/ESExplorer.apk
BOOTANIM=/system/media/bootanimation.zip
LOGO=/dev/block/logo

ui_print "- Creating temp dir"
COM=/tmp/oss/common
cd /
mkdir tmp
cd tmp
mkdir oss
cd oss

ui_print "- Unpacking"
unzip -o "$ZIP"

ui_print "- Installing apps"
cp_perm 0 0 0644 $COM/com.estrongs.android.pop.apk $APKNAME

ui_print "- Installing boot animation"
cp_perm 0 0 0644 $COM/bootanimation.zip $BOOTANIM

ui_print "- Installing boot logo"
cat $COM/logo.img > $LOGO 
ui_print "- Copied files"

ui_print "- Installing TOR"
mkdir /system/usr/tor
cp_perm 3003 3003 0644 $COM/tor/libcrypto.so.1.0.0 /system/usr/tor/libcrypto.so.1.0.0
cp_perm 3003 3003 0644 $COM/tor/libssl.so.1.0.0 /system/usr/tor/libssl.so.1.0.0
cp_perm 3003 3003 0644 $COM/tor/torrc /system/usr/tor/torrc
cp_perm 3003 3003 0755 $COM/tor/tor /system/usr/tor/tor
cp_perm 3003 3003 0755 $COM/tor/run.sh /system/usr/tor/run.sh

mkdir -p /data/oss/tor/data
mkdir -p /data/oss/tor/hidden_service
set_perm_recursive 3003 3003 755 /data/oss/tor

chown -R inet:inet /data/oss
chmod -R 700 /data/oss/tor

chown -R inet:inet /system/usr/tor
chmod 755 /system/usr/tor/tor
chmod 755 /system/usr/tor/run.sh

ui_print "- Unmounting /system and /data"
umount /system
umount /data

ui_print "- Done !"
exit 0
